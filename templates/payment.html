<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Scan to Pay – KHQR</title>
        {% include 'includes/head.html' %}
        <style>
        .ticket{width:360px;background:#fff;border:2px solid #222;border-radius:6px;
                box-shadow:0 6px 18px rgba(0,0,0,.12);overflow:hidden;margin:auto;}
        .head{background:#d72323;color:#fff;padding:22px 16px;text-align:center;position:relative;}
        .logo{font-weight:700;letter-spacing:2px;font-size:26px;line-height:1;}
        .head::after{content:'';position:absolute;right:-26px;top:0;width:0;height:0;
                    border-left:48px solid #fff;border-top:48px solid transparent;
                    transform:translateY(-6px) rotate(15deg);}
        .content{padding:18px 22px 8px 22px;}
        .company{color:#666;font-size:20px;margin-bottom:6px;}
        .amount-row{display:flex;align-items:baseline;gap:10px;}
        .amount{font-size:34px;font-weight:700;}
        .currency{color:#666;font-size:20px;}
        .divider{margin:18px 12px;border-top:2px dashed #cfcfcf;}
        .qr-wrap{padding:12px 18px 26px;display:flex;justify-content:center;}
        .qr{width:300px;height:300px;border:6px solid #fff;box-shadow:0 1px 0 rgba(0,0,0,.04);}
        .timer{font-size:20px;color:#333;text-align:center;}
        .expired{color:red;}
        .success{display:none;text-align:center;margin-top:20px;padding:20px;}
        .success h2{color:#2e8b57;margin:0;font-size:28px;}
        .success p{margin:8px 0 0;font-size:18px;}
        .success .small{color:#666;font-size:14px;}
    </style>
    </head>
    <body>
        <header>
            {% include 'includes/navbar.html' %}
        </header>
        <center class="mb-5">
            <div class="ticket" id="ticket">
                <div class="head"><div class="logo">KHQR</div></div>
                <div class="content">
                    <div class="company">{{ merchant_name }}</div>
                    <div class="amount-row">
                        <div class="amount">{{ price }}</div>
                        <div class="currency">{{ currency }}</div>
                    </div>
                    <br>
                    <div class="timer" id="countdown">05:00</div>
                </div>
                <div class="divider"></div>
                <div class="qr-wrap">
                    <img id="qr" src="{{ url_for('static', filename=qr) }}"
                        alt="QR" class="qr">
                </div>
            </div>

            <div class="success" id="success">
                <h2>Paid Successfully!</h2>
                <p>Thank you for your payment.</p>
                <p class="small">Redirecting…</p>
            </div>

            <input type="hidden" id="md5" value="{{ md5 }}">
        </center>
        <footer class="footer bg-dark text-white">
            {% include 'includes/footer.html' %}
        </footer>

        <script
            src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script>
    const md5 = document.getElementById('md5').value;
    let poll, timer;

    poll = setInterval(() => {
        axios.post('/check_payment_status', { md5 })
            .then(r => {
                console.log('Poll →', r.data);
                if (r.data.paid) {
                    clearInterval(poll);
                    clearInterval(timer);
                    document.getElementById('ticket').style.display = 'none';
                    document.getElementById('success').style.display = 'block';
                    setTimeout(() => window.location.replace("{{ url_for('customer_thanks') }}"), 1500);
                }
            })
            .catch(() => {});
    }, 3000);

    let secs = 300;
    const el = document.getElementById('countdown');
    timer = setInterval(() => {
        const m = String(Math.floor(secs/60)).padStart(2,'0');
        const s = String(secs%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
        if (--secs < 0) {
            clearInterval(timer);
            clearInterval(poll);
            el.textContent = 'Expired';
            el.classList.add('expired');
            document.getElementById('qr').style.display = 'none';
        }
    }, 1000);
</script>
    </body>
</html>